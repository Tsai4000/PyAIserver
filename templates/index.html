<html>
    <head>
        <title>home</title>
    </head>
    <script>

        function post(path, params, method='post') {

            // The rest of this code assumes you are not using a library.
            // It can be made less wordy if you use one.
            const form = document.createElement('form');
            form.method = method;
            form.action = path;

            for (const key in params) {
                if (params.hasOwnProperty(key)) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = key;
                    hiddenField.value = params[key];

                    form.appendChild(hiddenField);
                }
            }

            document.body.appendChild(form);
            form.submit();
        }

        async function handleUpload(e) {
            // STEP 2: 得到該檔案的 Blob, i.e., e.target.files
            const arrayBuffer = await getArrayBuffer(e[0]);
            console.log('arrayBuffer', arrayBuffer);

            const response = await uploadFile(arrayBuffer);
            console.log('response', response);
        }

        function getArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                // STEP 3: 轉成 ArrayBuffer, i.e., reader.result
                const reader = new FileReader();
                reader.addEventListener('load', () => {
                    resolve(reader.result);
                });
                reader.readAsDataURL(file);
            })
        }

        function uploadFile(arrayBuffer) {
            // var str = String.fromCharCode.apply(null, new Uint8Array(arrayBuffer));
            console.log(arrayBuffer)
            // bs64 = 'data:image/jpg;base64,' + btoa(str);
            return post('http://127.0.0.1:5000/predict', {
                    appId: 3,
                    format: 'png',
                        
                    // STEP 4：轉成 Uint8Array（這是 TypedArray）
                    // STEP 5：透過 Array.from 轉成真正的陣列
                    icon: arrayBuffer,
                })
            
            // fetch(`http://127.0.0.1:5000/predict`, {
            //     method: 'POST',
            //     contentType: 'application/json',
            //     dataType : 'json',
            //     // STEP 6：使用 JSON.stringify() 包起來送出
            //     data: JSON.stringify({
            //         appId: 3,
            //         format: 'png',
                        
            //         // STEP 4：轉成 Uint8Array（這是 TypedArray）
            //         // STEP 5：透過 Array.from 轉成真正的陣列
            //         icon: Array.from(new Uint8Array(arrayBuffer)),
            //     }),
            // }).then((res)=> {
            //     if (!res.ok) {
            //         throw res.statusText;
            //     }
            //     return res.json()
            // })
            // .then(({ data }) => console.log('data', data))
            // .catch(err => console.log('err', err))
        }
    </script>
    <body>
        <input type="file" onchange="handleUpload(this.files)">
    </body>
</html>